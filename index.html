<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<!-- iOS å…¨å±æ¨¡å¼ -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Calculator">
<!-- Android å…¨å±æ¨¡å¼ -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="180x180" href="apple-touch-icon.png">
<!-- PWA manifest for Android fullscreen -->
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2FsY3VsYXRvciIsInNob3J0X25hbWUiOiJDYWxjIiwiZGlzcGxheSI6ImZ1bGxzY3JlZW4iLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzAwMDAwMCIsInRoZW1lX2NvbG9yIjoiIzAwMDAwMCIsInN0YXJ0X3VybCI6Ii4ifQ==">
<title>Calculator</title>
<style>
  /* ========== Reset & Base ========== */
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  html, body {
    height: 100%; width: 100%;
    min-height: 101vh;
    overflow-x: hidden;
    overflow-y: auto;
    background: #000;
    font-family: -apple-system, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
    /* é˜²æ­¢ iOS æ©¡çš®ç­‹æ•ˆæœ */
    overscroll-behavior: none;
  }

  html.standalone-mode,
  html.standalone-mode body {
    height: 100%;
    height: -webkit-fill-available;
    min-height: 100%;
    overflow: hidden;
    position: fixed;
    inset: 0;
  }

  /* ========== é­”æœ¯æ¨¡å¼å…¨å±æ‹¦æˆªå±‚ ========== */
  .magic-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 9999;
    background: transparent;
    cursor: default;
  }
  .magic-overlay.active {
    display: block;
  }

  /* ========== Layout Container ========== */
  .calculator {
    display: flex;
    flex-direction: column;
    height: 100dvh;          /* dynamic viewport height */
    height: 100vh;
    max-width: 500px;
    margin: 0 auto;
    /* é€‚é… iOS åˆ˜æµ·å±å’Œ Android å…¨å±å®‰å…¨åŒºåŸŸ */
    padding: env(safe-area-inset-top) env(safe-area-inset-right) 0 env(safe-area-inset-left);
    padding-top: max(env(safe-area-inset-top), 0px);
    padding-bottom: 0;
  }

  html.standalone-mode .calculator {
    height: 100%;
    height: -webkit-fill-available;
  }

  /* ========== Display Area ========== */
  .display-area {
    flex: 1;
    display: flex;
    align-items: flex-end;
    justify-content: flex-end;
    padding: 0 24px 12px 24px;
    min-height: 0;
    position: relative;
    overflow: hidden;
  }

  /* --- ç§˜å¯†è§¦å‘åŒºåŸŸï¼šæ˜¾ç¤ºå±å·¦ä¾§ç©ºç™½é€æ˜å±‚ --- */
  .secret-trigger {
    position: absolute;
    left: 0; top: 0;
    width: 35%;
    height: 100%;
    z-index: 10;
    /* å®Œå…¨é€æ˜ï¼Œä¸å¯è§ */
    background: transparent;
    cursor: default;
  }

  .display-text {
    font-size: 88px;
    font-weight: 300;
    color: #fff;
    line-height: 1;
    text-align: right;
    word-break: break-all;
    max-width: 100%;
    transition: font-size 0.15s ease;
  }

  .display-text.shrink-1 { font-size: 68px; }
  .display-text.shrink-2 { font-size: 52px; }
  .display-text.shrink-3 { font-size: 40px; }

  /* ========== iOS ä¸»å±å¹•æç¤ºæ¡ ========== */
  .a2hs-tip {
    position: fixed;
    left: 12px;
    right: 12px;
    bottom: calc(12px + env(safe-area-inset-bottom));
    z-index: 10000;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: rgba(20, 20, 20, 0.92);
    color: #fff;
    display: none;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    font-size: 13px;
    line-height: 1.35;
  }
  .a2hs-tip.show {
    display: flex;
  }
  .a2hs-tip-btn {
    border: none;
    border-radius: 10px;
    padding: 6px 10px;
    font-size: 12px;
    font-weight: 600;
    color: #000;
    background: #fff;
    cursor: pointer;
    flex-shrink: 0;
  }

  /* ========== Button Grid ========== */
  .buttons {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    padding: 0 12px 12px 12px;
  }

  .btn {
    aspect-ratio: 1 / 1;
    border-radius: 50%;
    border: none;
    outline: none;
    font-size: 34px;
    font-weight: 400;
    font-family: inherit;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: filter 0.1s, transform 0.08s;
    appearance: none;
    -webkit-appearance: none;
    position: relative;
    overflow: hidden;
  }

  .btn:active { filter: brightness(1.4); }
  .btn.pressed {
    filter: brightness(1.4);
    transform: scale(0.96);
  }

  /* é€€æ ¼æŒ‰é’®å›¾æ ‡æ ·å¼ */
  .btn-backspace {
    font-size: 28px;
    letter-spacing: -1px;
  }

  .btn-top-row {
    color: #fff !important;
  }

  /* --- Color Themes --- */
  .btn-number   { background: #333; color: #fff; }
  .btn-operator { background: #ff9f0a; color: #fff; font-size: 40px; }
  .btn-function { background: #a5a5a5; color: #000; font-size: 26px; }

  /* Operator active (selected) state */
  .btn-operator.active {
    background: #fff;
    color: #ff9f0a;
  }

  /* ========== Responsive font sizes ========== */
  @media (max-height: 700px) {
    .display-text { font-size: 64px; }
    .display-text.shrink-1 { font-size: 52px; }
    .display-text.shrink-2 { font-size: 40px; }
    .display-text.shrink-3 { font-size: 32px; }
    .btn { font-size: 28px; }
    .btn-operator { font-size: 34px; }
  }
  @media (max-height: 600px) {
    .display-text { font-size: 48px; }
    .btn { font-size: 22px; }
    .btn-operator { font-size: 28px; }
    .buttons { gap: 8px; padding: 0 8px 8px 8px; }
  }
</style>
</head>
<body>

<!-- ğŸ© é­”æœ¯æ¨¡å¼å…¨å±æ‹¦æˆªå±‚ï¼šç‚¹å‡»ä»»æ„ä½ç½®éƒ½è§†ä¸ºæŒ‰ä¸‹æ•°å­—é”® -->
<div class="magic-overlay" id="magicOverlay"></div>

<!-- iOS æµè§ˆå™¨æ¨¡å¼æç¤ºï¼šå¼•å¯¼æ·»åŠ åˆ°ä¸»å±å¹• -->
<div class="a2hs-tip" id="a2hsTip" role="status" aria-live="polite">
  <span>åœ¨ iPhone ç‚¹â€œåˆ†äº«â€â†’â€œæ·»åŠ åˆ°ä¸»å±å¹•â€ï¼Œå¯éšè—åœ°å€æ ä¸åº•æ ã€‚</span>
  <button class="a2hs-tip-btn" id="a2hsTipClose" type="button">çŸ¥é“äº†</button>
</div>

<div class="calculator">
  <!-- æ˜¾ç¤ºåŒºåŸŸ -->
  <div class="display-area">
    <!-- ç§˜å¯†è§¦å‘åŒºåŸŸï¼ˆé€æ˜å±‚ï¼Œè¦†ç›–æ˜¾ç¤ºå±å·¦ä¾§ï¼‰ -->
    <div class="secret-trigger" id="secretTrigger"></div>
    <div class="display-text" id="display">0</div>
  </div>

  <!-- æŒ‰é’®åŒºåŸŸ -->
  <div class="buttons">
    <!-- Row 1: âŒ«  C/AC  %  Ã· -->
    <button class="btn btn-function btn-backspace btn-top-row" data-action="backspace">âŒ«</button>
    <button class="btn btn-function btn-top-row" data-action="clear">AC</button>
    <button class="btn btn-function btn-top-row" data-action="percent">%</button>
    <button class="btn btn-operator btn-top-row" data-action="operator" data-op="Ã·">Ã·</button>

    <!-- Row 2: 7 8 9 Ã— -->
    <button class="btn btn-number" data-action="digit" data-val="7">7</button>
    <button class="btn btn-number" data-action="digit" data-val="8">8</button>
    <button class="btn btn-number" data-action="digit" data-val="9">9</button>
    <button class="btn btn-operator" data-action="operator" data-op="Ã—">Ã—</button>

    <!-- Row 3: 4 5 6 âˆ’ -->
    <button class="btn btn-number" data-action="digit" data-val="4">4</button>
    <button class="btn btn-number" data-action="digit" data-val="5">5</button>
    <button class="btn btn-number" data-action="digit" data-val="6">6</button>
    <button class="btn btn-operator" data-action="operator" data-op="âˆ’">âˆ’</button>

    <!-- Row 4: 1 2 3 + -->
    <button class="btn btn-number" data-action="digit" data-val="1">1</button>
    <button class="btn btn-number" data-action="digit" data-val="2">2</button>
    <button class="btn btn-number" data-action="digit" data-val="3">3</button>
    <button class="btn btn-operator" data-action="operator" data-op="+">+</button>

    <!-- Row 5: Â±  0  .  = -->
    <button class="btn btn-number" data-action="negate">+/âˆ’</button>
    <button class="btn btn-number" data-action="digit" data-val="0">0</button>
    <button class="btn btn-number" data-action="decimal">.</button>
    <button class="btn btn-operator" data-action="equals">=</button>
  </div>
</div>

<script>
(function () {
  'use strict';

  // ============================================================
  //  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  State Variables
  // ============================================================
  let displayValue  = '0';   // å½“å‰æ˜¾ç¤ºçš„æ–‡æœ¬
  let firstOperand  = null;  // ç¬¬ä¸€æ“ä½œæ•°
  let operator      = null;  // å½“å‰è¿ç®—ç¬¦
  let waitingForSecondOperand = false; // æ˜¯å¦ç­‰å¾…ç¬¬äºŒæ“ä½œæ•°è¾“å…¥
  const displayEl   = document.getElementById('display');

  // ============================================================
  //  ğŸ© é­”æœ¯é€»è¾‘ çŠ¶æ€å˜é‡
  // ============================================================
  let magicMode       = false;  // é­”æœ¯æ¨¡å¼æ˜¯å¦æ¿€æ´»
  let magicNumber     = '';     // è®¡ç®—å‡ºçš„ä¿®æ­£å€¼å­—ç¬¦ä¸²ï¼ˆå°†é€ä½å±•ç¤ºï¼‰
  let magicIndex      = 0;     // å½“å‰å·²å±•ç¤ºåˆ° magicNumber çš„ç¬¬å‡ ä½
  let magicReady      = false;  // æ ‡è®°ï¼šæ˜¯å¦å·²æŒ‰ä¸‹ + è¿›å…¥å‡†å¤‡çŠ¶æ€
  // magicReady = true è¡¨ç¤ºé­”æœ¯å¸ˆå·²æŒ‰ä¸‹ +ï¼Œæ­¤æ—¶ç‚¹å‡»ç§˜å¯†åŒºåŸŸæ‰èƒ½è§¦å‘

  // ============================================================
  //  ğŸ”§ éšè—é…ç½®çŠ¶æ€ï¼ˆC æ¸…é›¶åè¾“å…¥ 2026=====ï¼‰
  // ============================================================
  const SECRET_CONFIG_CODE = '2026=====';
  let configCodeBuffer = '';          // éšè—æŒ‡ä»¤è¾“å…¥ç¼“å†²
  let configMode = false;             // æ˜¯å¦æ­£åœ¨è¾“å…¥ç¼“å†²ç§’æ•°
  let configInputValue = '';          // é…ç½®æ¨¡å¼ä¸‹è¾“å…¥å€¼
  let bufferSecondBase = 20;          // getTargetTimeResult ç¼“å†²ç§’æ•°åŸºæ•°ï¼ˆ0~60ï¼‰

  // ============================================================
  //  Display Helpers
  // ============================================================
  function updateDisplay(val) {
    if (val === undefined) val = displayValue;
    // æ ¼å¼åŒ–æ•°å­—ï¼šæ·»åŠ åƒåˆ†ä½é€—å·
    let text = val;
    if (!isNaN(parseFloat(val)) && isFinite(val)) {
      const parts = val.split('.');
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      text = parts.join('.');
    }
    displayEl.textContent = text;

    // æ ¹æ®å­—ç¬¦é•¿åº¦åŠ¨æ€ç¼©å°
    const len = text.length;
    displayEl.className = 'display-text';
    if (len > 12)      displayEl.classList.add('shrink-3');
    else if (len > 9)  displayEl.classList.add('shrink-2');
    else if (len > 6)  displayEl.classList.add('shrink-1');
  }

  // ============================================================
  //  Core Calculator Functions
  // ============================================================
  function inputDigit(digit) {
    if (configMode) {
      handleConfigDigit(digit);
      return;
    }

    // -----------------------------------------------------------
    //  ğŸ© é­”æœ¯æ¨¡å¼ï¼šæ‹¦æˆªæ•°å­—è¾“å…¥ï¼Œé€ä½å±•ç¤º MagicNumber
    // -----------------------------------------------------------
    if (magicMode) {
      if (magicIndex >= magicNumber.length) return; // å·²å…¨éƒ¨å±•ç¤ºï¼Œå¿½ç•¥åç»­ç‚¹å‡»
      magicIndex++;
      displayValue = magicNumber.substring(0, magicIndex);
      updateDisplay();
      // å½“å…¨éƒ¨å±•ç¤ºå®Œæ¯•æ—¶ï¼Œå…³é—­å…¨å±æ‹¦æˆªå±‚ï¼ˆåç»­æŒ‰ = éœ€è¦æ­£å¸¸å“åº”ï¼‰
      if (magicIndex >= magicNumber.length) {
        document.getElementById('magicOverlay').classList.remove('active');
      }
      return;
    }
    // -----------------------------------------------------------

    if (waitingForSecondOperand) {
      displayValue = digit;
      waitingForSecondOperand = false;
    } else {
      displayValue = displayValue === '0' ? digit : displayValue + digit;
    }
    updateDisplay();

    // è¾“å…¥ä»»æ„æ•°å­—åï¼ŒAC ç«‹åˆ»å˜æˆ C
    document.querySelector('[data-action="clear"]').textContent = 'C';
  }

  function inputDecimal() {
    if (magicMode) return; // é­”æœ¯æ¨¡å¼ä¸‹å¿½ç•¥å°æ•°ç‚¹
    if (waitingForSecondOperand) {
      displayValue = '0.';
      waitingForSecondOperand = false;
      updateDisplay();
      return;
    }
    if (!displayValue.includes('.')) {
      displayValue += '.';
    }
    updateDisplay();
  }

  function handleOperator(nextOp) {
    const inputValue = parseFloat(displayValue);

    // -----------------------------------------------------------
    //  ğŸ© å‡†å¤‡é˜¶æ®µæ ‡è®°ï¼šå½“ + è¢«æŒ‰ä¸‹æ—¶ï¼Œè®¾ç½® magicReady
    //     è¿™æ„å‘³ç€é­”æœ¯å¸ˆå·²ç»ç”¨ + æŠŠå½“å‰ sum é”å®šäº†
    // -----------------------------------------------------------
    if (nextOp === '+') {
      magicReady = true;
    } else {
      magicReady = false;
    }
    // -----------------------------------------------------------

    // é€€å‡ºé­”æœ¯æ¨¡å¼äºè¿ç®—ç¬¦åˆ‡æ¢æ—¶ï¼ˆå®‰å…¨å›é€€ï¼‰
    // æ­£å¸¸ä¸ä¼šèµ°åˆ°è¿™é‡Œï¼Œå› ä¸ºé­”æœ¯æ¨¡å¼ä¸‹åç»­æŒ‰ = å°±å®Œæˆ

    if (operator && !waitingForSecondOperand) {
      const result = calculate(firstOperand, inputValue, operator);
      displayValue = String(result);
      firstOperand = result;
    } else {
      firstOperand = inputValue;
    }

    operator = nextOp;
    waitingForSecondOperand = true;

    // é«˜äº®å½“å‰è¿ç®—ç¬¦
    highlightOperator(nextOp);
    updateDisplay();
  }

  function calculate(a, b, op) {
    switch (op) {
      case '+': return a + b;
      case 'âˆ’': return a - b;
      case 'Ã—': return a * b;
      case 'Ã·': return b !== 0 ? a / b : 'Error';
      default:  return b;
    }
  }

  function handleEquals() {
    if (configMode) {
      submitConfigValue();
      return;
    }

    // -----------------------------------------------------------
    //  ğŸ© ç­‰å·æ‰§è¡Œæ­£å¸¸æ•°å­¦è¿ç®—
    //     åœ¨é­”æœ¯æµç¨‹ä¸­ï¼šfirstOperand(CurrentSum) + MagicNumber = TargetResult
    //     è¿™é‡Œä¸åšä»»ä½•å¼ºåˆ¶è¦†ç›–ï¼Œå®Œå…¨ç”±æ•°å­¦ä¿è¯ç»“æœ
    // -----------------------------------------------------------
    if (operator === null || waitingForSecondOperand) {
      // å¦‚æœè¿˜åœ¨ç­‰ç¬¬äºŒæ“ä½œæ•°è€Œç”¨æˆ·ç›´æ¥æŒ‰ =,ç”¨å½“å‰æ˜¾ç¤ºå€¼
      if (operator && waitingForSecondOperand) {
        const b = parseFloat(displayValue);
        const result = calculate(firstOperand, b, operator);
        displayValue = formatResult(result);
      }
      clearHighlight();
      updateDisplay();
      // é‡ç½®é­”æœ¯çŠ¶æ€
      resetMagicState();
      return;
    }

    const secondOperand = parseFloat(displayValue);
    const result = calculate(firstOperand, secondOperand, operator);

    displayValue = formatResult(result);
    firstOperand = null;
    operator = null;
    waitingForSecondOperand = false;

    clearHighlight();
    updateDisplay();

    // é‡ç½®é­”æœ¯çŠ¶æ€
    resetMagicState();
  }

  function formatResult(result) {
    if (typeof result === 'string') return result; // 'Error'
    // é¿å…æµ®ç‚¹ç²¾åº¦é—®é¢˜ï¼Œæœ€å¤šä¿ç•™10ä½å°æ•°
    let str = parseFloat(result.toFixed(10)).toString();
    return str;
  }

  function handleClear() {
    const clearBtn = document.querySelector('[data-action="clear"]');

    displayValue = '0';
    firstOperand = null;
    operator = null;
    waitingForSecondOperand = false;
    clearHighlight();
    updateDisplay();
    // æŒ‰ AC ä¹Ÿé‡ç½®é­”æœ¯
    resetMagicState();
    // æ›´æ–°æŒ‰é’®æ–‡å­—
    clearBtn.textContent = 'AC';

    // æ¸…é›¶åé‡ç½®éšè—å£ä»¤ç¼“å†²
    configCodeBuffer = '';

    // æ¸…é›¶æ—¶é€€å‡ºé…ç½®æ¨¡å¼
    configMode = false;
    configInputValue = '';
  }

  function handleNegate() {
    if (magicMode) return;
    if (displayValue === '0' || displayValue === 'Error') return;
    displayValue = displayValue.charAt(0) === '-'
      ? displayValue.substring(1)
      : '-' + displayValue;
    updateDisplay();
  }

  function handlePercent() {
    if (magicMode) return;
    const val = parseFloat(displayValue);
    if (isNaN(val)) return;
    displayValue = String(parseFloat((val / 100).toFixed(10)));
    updateDisplay();
  }

  function handleBackspace() {
    if (configMode) {
      if (configInputValue.length === 0) return;
      configInputValue = configInputValue.slice(0, -1);
      updateDisplay(configInputValue || '0');
      return;
    }

    if (magicMode) return;
    if (displayValue === '0' || displayValue === 'Error') return;
    if (waitingForSecondOperand) return;
    if (displayValue.length === 1 || (displayValue.length === 2 && displayValue.charAt(0) === '-')) {
      displayValue = '0';
    } else {
      displayValue = displayValue.slice(0, -1);
    }
    updateDisplay();
  }

  function trackConfigCode(token) {
    if (configMode || magicMode) return;

    // åªè¦åœ¨å½’é›¶ç•Œé¢å¼€å§‹è¾“å…¥å³å¯è§¦å‘ï¼ˆåŒ…æ‹¬åˆšè¿›å…¥é¡µé¢ï¼‰
    const isZeroScreen = displayValue === '0';

    // å°šæœªå¼€å§‹åŒ¹é…æ—¶ï¼Œå¿…é¡»ä»å½’é›¶ç•Œé¢å¼€å§‹ï¼Œä¸”é¦–å­—ç¬¦åŒ¹é…
    if (configCodeBuffer.length === 0) {
      if (!isZeroScreen || token !== SECRET_CONFIG_CODE.charAt(0)) return;
      configCodeBuffer = token;
      return;
    }

    const next = configCodeBuffer + token;
    if (SECRET_CONFIG_CODE.startsWith(next)) {
      configCodeBuffer = next;
      if (configCodeBuffer === SECRET_CONFIG_CODE) {
        enterConfigMode();
      }
      return;
    }
    configCodeBuffer = '';
  }

  function enterConfigMode() {
    configMode = true;
    configCodeBuffer = '';
    configInputValue = '';

    displayValue = '0';
    firstOperand = null;
    operator = null;
    waitingForSecondOperand = false;
    clearHighlight();
    updateDisplay('0');

    console.log('%cğŸ”§ CONFIG MODE', 'color:#34c759;font-size:14px;font-weight:bold;');
    console.log('  è¯·è¾“å…¥ 0~60 åæŒ‰ = ä¿å­˜ï¼Œå½“å‰åŸºæ•°:', bufferSecondBase);
  }

  function handleConfigDigit(digit) {
    if (configInputValue.length >= 2) return;
    if (configInputValue === '' && digit === '0') {
      configInputValue = '0';
    } else if (configInputValue === '0') {
      configInputValue = digit;
    } else {
      configInputValue += digit;
    }
    updateDisplay(configInputValue);
  }

  function submitConfigValue() {
    let nextValue = parseInt(configInputValue || '0', 10);
    if (isNaN(nextValue)) nextValue = bufferSecondBase;
    if (nextValue < 0) nextValue = 0;
    if (nextValue > 60) nextValue = 60;

    bufferSecondBase = nextValue;
    configMode = false;
    configInputValue = '';

    displayValue = '0';
    firstOperand = null;
    operator = null;
    waitingForSecondOperand = false;
    clearHighlight();
    updateDisplay('0');
    document.querySelector('[data-action="clear"]').textContent = 'AC';

    console.log('%câœ… BUFFER CONFIG SAVED', 'color:#34c759;font-size:14px;font-weight:bold;');
    console.log('  bufferSecondBase =', bufferSecondBase);
  }

  // ============================================================
  //  Operator Highlight
  // ============================================================
  function highlightOperator(op) {
    clearHighlight();
    const opMap = { '+': '+', 'âˆ’': 'âˆ’', 'Ã—': 'Ã—', 'Ã·': 'Ã·' };
    document.querySelectorAll('.btn-operator[data-op]').forEach(btn => {
      if (btn.dataset.op === op) btn.classList.add('active');
    });
  }

  function clearHighlight() {
    document.querySelectorAll('.btn-operator').forEach(btn => btn.classList.remove('active'));
  }

  // ============================================================
  //  ğŸ© é­”æœ¯é€»è¾‘æ ¸å¿ƒ â€” Secret Trigger & Magic Number Calculation
  // ============================================================

  /**
   * é‡ç½®é­”æœ¯çŠ¶æ€
   */
  function resetMagicState() {
    magicMode   = false;
    magicNumber = '';
    magicIndex  = 0;
    magicReady  = false;
    // å…³é—­å…¨å±æ‹¦æˆªå±‚
    document.getElementById('magicOverlay').classList.remove('active');
  }

  /**
   * è·å–"æœªæ¥æ—¶é—´"æ ¼å¼åŒ–ä¸º MMDDhhmmï¼ˆ8ä½æ•°å­—ï¼‰
   * æ™ºèƒ½åˆ¤æ–­ï¼ˆå¯é…ç½®ï¼‰ï¼š
   *   - å¦‚æœå½“å‰ç§’æ•° < bufferSecondBaseï¼šä½¿ç”¨å½“å‰åˆ†é’Ÿ
   *   - å¦‚æœå½“å‰ç§’æ•° >= bufferSecondBaseï¼š+1 åˆ†é’Ÿ
   */
  function getTargetTimeResult() {
    const now = new Date();
    const seconds = now.getSeconds();
    const target = new Date(now.getTime());

    if (seconds < bufferSecondBase) {
      // ç§’æ•°åœ¨ç¼“å†²åŸºæ•°å†…ï¼Œç›´æ¥ä½¿ç”¨å½“å‰åˆ†é’Ÿ
      target.setMinutes(target.getMinutes() + 0);
    } else {
      // ç§’æ•°è¶…è¿‡ç¼“å†²åŸºæ•°ï¼Œ+1 åˆ†é’Ÿ
      target.setMinutes(target.getMinutes() + 1);
    }
    target.setSeconds(0);
    target.setMilliseconds(0);

    const MM = String(target.getMonth() + 1).padStart(2, '0');
    const DD = String(target.getDate()).padStart(2, '0');
    const hh = String(target.getHours()).padStart(2, '0');
    const mm = String(target.getMinutes()).padStart(2, '0');

    return MM + DD + hh + mm; // e.g. "02172031"
  }

  /**
   * ç§˜å¯†è§¦å‘äº‹ä»¶å¤„ç†
   * æ¡ä»¶ï¼šå¿…é¡»å·²æŒ‰ä¸‹ +ï¼ˆmagicReady = trueï¼‰
   * é€»è¾‘ï¼š
   *   1. è·å– CurrentSum = firstOperandï¼ˆå³ + ä¹‹å‰çš„ç»“æœï¼‰
   *   2. è®¡ç®— TargetResult = MMDDhhmm (å½“å‰æ—¶é—´ + çº¦1åˆ†é’Ÿ)
   *   3. MagicNumber = TargetResult - CurrentSum
   *   4. å¦‚æœ MagicNumber <= 0ï¼Œç›´æ¥è®© MagicNumber = TargetResult
   *   5. æ¿€æ´»é­”æœ¯æ¨¡å¼ï¼Œè¿›å…¥"é€ä½å±•ç¤º"çŠ¶æ€
   */
  function activateMagic() {
    if (!magicReady) return;     // å¿…é¡»å…ˆæŒ‰ +
    if (magicMode) return;       // å·²ç»æ¿€æ´»è¿‡äº†

    const currentSum = firstOperand; // + å·ä¹‹å‰çš„æ“ä½œæ•°
    if (currentSum === null || isNaN(currentSum)) return;

    const targetStr  = getTargetTimeResult();           // "02172032"
    const targetNum  = parseInt(targetStr, 10);         // 2172032
    let magicNum     = targetNum - currentSum;

    // å¦‚æœä¿®æ­£å€¼ä¸ºè´Ÿæˆ–é›¶ï¼ˆæç«¯æƒ…å†µï¼‰ï¼Œç›´æ¥ç”¨ç›®æ ‡å€¼
    if (magicNum <= 0) {
      magicNum = targetNum;
      // åŒæ—¶é‡ç½® firstOperand ä¸º 0ï¼Œè¿™æ · 0 + magicNum = targetNum
      firstOperand = 0;
    }

    magicNumber = String(magicNum);
    magicIndex  = 0;
    magicMode   = true;

    // ğŸ© æ§åˆ¶å°è¾“å‡ºæ ‡å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•ç¡®è®¤é­”æœ¯å·²æ¿€æ´»
    console.log('%cğŸ© MAGIC MODE ACTIVATED', 'color: #ff9f0a; font-size: 16px; font-weight: bold;');
    console.log('  Target Time:', targetStr);
    console.log('  CurrentSum:', currentSum);
    console.log('  MagicNumber:', magicNumber);

    // ä¿æŒå½“å‰æ˜¾ç¤ºä¸å˜ï¼ˆå±å¹•ä»æ˜¾ç¤º CurrentSumï¼‰ï¼Œä¸è¦è·³å˜åˆ° 0
    // displayValue ä¿æŒä¹‹å‰çš„å€¼ï¼Œç­‰ç”¨æˆ·ç¬¬ä¸€æ¬¡æŒ‰é”®æ—¶å†å¼€å§‹é€ä½å±•ç¤º
    waitingForSecondOperand = false; // å…è®¸ digit è¾“å…¥è¿›å…¥æ‹¦æˆªæµç¨‹

    // æ¿€æ´»å…¨å±æ‹¦æˆªå±‚
    document.getElementById('magicOverlay').classList.add('active');
  }

  // ç»‘å®šç§˜å¯†è§¦å‘åŒºåŸŸ
  document.getElementById('secretTrigger').addEventListener('click', function (e) {
    e.stopPropagation();
    activateMagic();
  });

  // ğŸ© å…¨å±æ‹¦æˆªå±‚ï¼šé­”æœ¯æ¨¡å¼ä¸‹ç‚¹å‡»ä»»æ„ä½ç½®éƒ½è§†ä¸ºæŒ‰ä¸‹æ•°å­—é”®
  document.getElementById('magicOverlay').addEventListener('click', function (e) {
    e.stopPropagation();
    e.preventDefault();
    if (magicMode) {
      inputDigit('0'); // å‚æ•°æ— æ‰€è°“ï¼Œé­”æœ¯æ¨¡å¼ä¸‹ä¼šè¢«æ‹¦æˆªæˆ MagicNumber çš„ä¸‹ä¸€ä½
    }
  });
  // åŒæ—¶æ‹¦æˆª touchend é˜²æ­¢ç§»åŠ¨ç«¯å»¶è¿Ÿ
  document.getElementById('magicOverlay').addEventListener('touchend', function (e) {
    e.stopPropagation();
    e.preventDefault();
    if (magicMode) {
      inputDigit('0');
    }
  });

  // ============================================================
  //  Event Delegation â€” Button Clicks
  // ============================================================
  document.querySelector('.buttons').addEventListener('click', function (e) {
    const btn = e.target.closest('.btn');
    if (!btn) return;

    const action = btn.dataset.action;

    // æŒ‰ä»»ä½•é AC é”®æ—¶ï¼Œå°† AC æ˜¾ç¤ºä¸º Cï¼ˆiOS è¡Œä¸ºï¼‰
    if (action !== 'clear' && displayValue !== '0') {
      document.querySelector('[data-action="clear"]').textContent = 'C';
    }

    switch (action) {
      case 'digit':
        if (configMode) {
          inputDigit(btn.dataset.val);
          break;
        }
        trackConfigCode(btn.dataset.val);
        if (configMode) break;
        inputDigit(btn.dataset.val);
        clearHighlight();
        break;
      case 'decimal':
        inputDecimal();
        clearHighlight();
        break;
      case 'operator':
        handleOperator(btn.dataset.op);
        break;
      case 'equals':
        if (configMode) {
          handleEquals();
          break;
        }
        trackConfigCode('=');
        if (configMode) break;
        handleEquals();
        break;
      case 'clear':
        handleClear();
        break;
      case 'negate':
        handleNegate();
        break;
      case 'percent':
        handlePercent();
        break;
      case 'backspace':
        handleBackspace();
        break;
    }
  });

  // ============================================================
  //  æµè§ˆå™¨æ¨¡å¼ä¸‹å°è¯•æ”¶èµ·åœ°å€æ /å·¥å…·æ ï¼ˆiOS/Androidï¼‰
  //  æ³¨æ„ï¼šæµè§ˆå™¨æ¨¡å¼æ— æ³•å¼ºåˆ¶æ°¸ä¹…éšè—ï¼ŒPWA ç‹¬ç«‹æ¨¡å¼æ‰å¯å®Œå…¨æ— åœ°å€æ 
  // ============================================================
  function isStandaloneMode() {
    return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
  }

  function applyStandaloneModeClass() {
    document.documentElement.classList.toggle('standalone-mode', isStandaloneMode());
  }

  function tryHideBrowserBars() {
    if (isStandaloneMode()) return;
    requestAnimationFrame(function () {
      setTimeout(function () { window.scrollTo(0, 1); }, 60);
    });
  }

  const A2HS_TIP_KEY = 'a2hs-tip-dismissed-v1';

  function isIOS() {
    return /iPhone|iPad|iPod/i.test(window.navigator.userAgent);
  }

  function isIOSBrowserMode() {
    return isIOS() && !isStandaloneMode();
  }

  function hasDismissedA2HSTip() {
    try {
      return window.localStorage.getItem(A2HS_TIP_KEY) === '1';
    } catch (err) {
      return false;
    }
  }

  function dismissA2HSTip() {
    const tipEl = document.getElementById('a2hsTip');
    if (tipEl) tipEl.classList.remove('show');
    try {
      window.localStorage.setItem(A2HS_TIP_KEY, '1');
    } catch (err) {}
  }

  function maybeShowA2HSTip() {
    if (!isIOSBrowserMode()) return;
    if (hasDismissedA2HSTip()) return;
    const tipEl = document.getElementById('a2hsTip');
    if (!tipEl) return;
    setTimeout(function () {
      tipEl.classList.add('show');
    }, 900);
  }

  window.addEventListener('load', tryHideBrowserBars);
  window.addEventListener('pageshow', tryHideBrowserBars);
  window.addEventListener('orientationchange', tryHideBrowserBars);
  window.addEventListener('load', maybeShowA2HSTip);
  window.addEventListener('load', applyStandaloneModeClass);
  window.addEventListener('pageshow', applyStandaloneModeClass);

  if (isStandaloneMode()) {
    document.addEventListener('touchmove', function (e) { e.preventDefault(); }, { passive: false });
  }

  document.querySelector('.buttons').addEventListener('touchstart', function (e) {
    const btn = e.target.closest('.btn');
    if (!btn) return;
    btn.classList.add('pressed');
  }, { passive: true });

  document.querySelector('.buttons').addEventListener('touchend', function () {
    document.querySelectorAll('.btn.pressed').forEach(function (el) { el.classList.remove('pressed'); });
  });

  document.querySelector('.buttons').addEventListener('touchcancel', function () {
    document.querySelectorAll('.btn.pressed').forEach(function (el) { el.classList.remove('pressed'); });
  });

  document.querySelector('.buttons').addEventListener('mousedown', function (e) {
    const btn = e.target.closest('.btn');
    if (!btn) return;
    btn.classList.add('pressed');
  });

  document.addEventListener('mouseup', function () {
    document.querySelectorAll('.btn.pressed').forEach(function (el) { el.classList.remove('pressed'); });
  });

  const a2hsCloseBtn = document.getElementById('a2hsTipClose');
  if (a2hsCloseBtn) {
    a2hsCloseBtn.addEventListener('click', dismissA2HSTip);
  }

  // é˜»æ­¢åŒå‡»ç¼©æ”¾å’Œé•¿æŒ‰èœå•
  document.addEventListener('dblclick', function (e) { e.preventDefault(); });
  document.addEventListener('contextmenu', function (e) { e.preventDefault(); });

  // åˆå§‹åŒ–æ˜¾ç¤º
  updateDisplay();

})();
</script>

</body>
</html>
